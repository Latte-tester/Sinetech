name: Workflow Temizleyici

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Hatalı Workflow'ları Temizle
        uses: actions/github-script@v7
        with:
          script: |
            async function deleteWorkflowRuns() {
              let page = 1;
              let hasMoreRuns = true;
              let totalDeleted = 0;
              
              while (hasMoreRuns) {
                try {
                  const runs = await github.rest.actions.listWorkflowRunsForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    status: 'failure',
                    per_page: 100,
                    page: page
                  });
                  
                  if (!runs?.data?.workflow_runs?.length) {
                    hasMoreRuns = false;
                    break;
                  }
                  
                  console.log(`İşleniyor: Sayfa ${page}, ${runs.data.workflow_runs.length} adet workflow`);
                  
                  for (const run of runs.data.workflow_runs) {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: run.id
                      });
                      totalDeleted++;
                      console.log(`Silindi: ${run.name} (ID: ${run.id})`);
                    } catch (deleteError) {
                      console.log(`Hata: ${run.name} (ID: ${run.id}) silinirken hata oluştu:`, deleteError);
                    }
                  }
                  
                  page++;
                } catch (error) {
                  console.log('API çağrısı sırasında hata:', error);
                  hasMoreRuns = false;
                }
              }
              
              console.log(`Temizleme işlemi tamamlandı. Toplam ${totalDeleted} workflow silindi.`);
            }
            
            await deleteWorkflowRuns();